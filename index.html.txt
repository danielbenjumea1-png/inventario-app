// Código JavaScript extraído y corregido del HTML proporcionado.
// Nota: Este código asume que se ejecuta en un entorno con acceso a DOM (como un navegador web).
// Se ha corregido un error de sintaxis en la línea original: if (codigoAFila[codigo] !== ) { ahora es !== undefined.
// También se ha estructurado para mayor claridad, pero mantiene la funcionalidad original.

let inventario = JSON.parse(localStorage.getItem('inventario')) || [];
let codigoAFila = {};

// Inicializar mapeo
inventario.forEach((item, index) => {
    codigoAFila[item.codigo] = index;
});

// Inicializar QuaggaJS (requiere que el elemento #interactive esté en el DOM)
Quagga.init({
    inputStream: {
        name: "Live",
        type: "LiveStream",
        target: document.querySelector('#interactive'),
        constraints: {
            width: 640,
            height: 480,
            facingMode: "environment" // Usar cámara trasera en móvil
        }
    },
    locator: {
        patchSize: "medium",
        halfSample: true
    },
    numOfWorkers: 2,
    decoder: {
        readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader"] // Tipos comunes de códigos de barras
    },
    locate: true
}, function(err) {
    if (err) {
        console.log(err);
        return;
    }
    Quagga.start();
});

// Manejar detección
Quagga.onDetected(function(result) {
    let code = result.codeResult.code;
    code = code.toUpperCase().replace(/[^A-Z0-9]/g, ''); // Limpiar y convertir a mayúsculas

    // Filtrar códigos que empiecen con B y tengan longitud adecuada
    if (!code.startsWith('B') || code.length < 7) return;

    procesarCodigo(code);
});

function procesarCodigo(codigo) {
    if (codigoAFila[codigo] !== undefined) {
        // Marcar como encontrado (verde)
        inventario[codigoAFila[codigo]].estado = 'encontrado';
        document.getElementById('result').innerHTML = `<p style="color: green;">✔ Código ${codigo} encontrado y marcado en verde.</p>`;
    } else {
        // Agregar nuevo (morado)
        inventario.push({ codigo: codigo, estado: 'nuevo' });
        codigoAFila[codigo] = inventario.length - 1;
        document.getElementById('result').innerHTML = `<p style="color: purple;">➕ Código nuevo agregado: ${codigo}</p>`;
    }
    guardarInventario();
    actualizarTabla();
}

function procesarManual() {
    let codigo = document.getElementById('codigoManual').value.trim().toUpperCase();
    if (codigo) {
        procesarCodigo(codigo);
        document.getElementById('codigoManual').value = '';
    } else {
        alert('Por favor, ingresa un código.');
    }
}

function guardarInventario() {
    localStorage.setItem('inventario', JSON.stringify(inventario));
    // Crear "backup" guardando una copia en localStorage con timestamp
    localStorage.setItem('inventario_backup_' + Date.now(), JSON.stringify(inventario));
}

function actualizarTabla() {
    let tbody = document.querySelector('#inventarioTable tbody');
    tbody.innerHTML = '';
    inventario.forEach(item => {
        let row = `<tr class="${item.estado === 'encontrado' ? 'verde' : 'morado'}"><td>${item.codigo}</td><td>${item.estado}</td></tr>`;
        tbody.innerHTML += row;
    });
}

function descargarExcel() {
    let ws = XLSX.utils.json_to_sheet(inventario);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventario");
    XLSX.writeFile(wb, "inventario_actualizado.xlsx");
}

function subirSharePoint() {
    // Placeholder: Reemplaza con tu URL de SharePoint
    let sharePointUrl = 'https://ucceduco-my.sharepoint.com/:x:/r/personal/daniel_benjumea_ucc_edu_co/Documents/inventario%20-%20solo%20codigos.xlsx?d=wdb1f92c8b2f246599c69a9b22ccf2ac6&csf=1&web=1&e=ZzeydF'; // El usuario pone esto
    let data = JSON.stringify(inventario);

    fetch(sharePointUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: data
    })
    .then(response => {
        if (response.ok) {
            alert('Inventario subido exitosamente a SharePoint.');
        } else {
            alert('Error al subir a SharePoint.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexión.');
    });
}

// Inicializar tabla al cargar (llama esto después de que el DOM esté listo)
actualizarTabla();
